{% extends "base.html" %}

{% block title %}Shopping Cart{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb">
  <div class="container">
    <a href="/" class="breadcrumb-item">Home</a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-item active">Shopping Cart</span>
  </div>
</div>
{% endblock %}

{% block content %}
<section class="cart-page">
  <div class="container">
    <h1 class="page-title">Shopping Cart</h1>

    {% if cart and cart.items|length > 0 %}
      <div class="cart-layout">
        <!-- Cart Items -->
        <div class="cart-items">
          <div class="cart-header">
            <span class="cart-header-product">Product</span>
            <span class="cart-header-price">Price</span>
            <span class="cart-header-quantity">Quantity</span>
            <span class="cart-header-total">Total</span>
            <span class="cart-header-actions"></span>
          </div>

          {% for item in cart.items %}
            <article class="cart-item" data-item-id="{{ item.id }}">
              <div class="cart-item-product">
                <a href="/products/{{ item.product.slug }}" class="cart-item-image">
                  <img src="{{ item.product.images.0.url|default('/images/placeholder.svg') }}" alt="{{ item.product.name }}">
                </a>
                <div class="cart-item-info">
                  <h3 class="cart-item-name">
                    <a href="/products/{{ item.product.slug }}">{{ item.product.name }}</a>
                  </h3>
                  {% if item.variant %}
                    <div class="cart-item-options">
                      {% for attr in item.variant.attributes %}
                        <span>{{ attr.name }}: {{ attr.value }}</span>
                      {% endfor %}
                    </div>
                  {% endif %}
                  <div class="cart-item-sku">SKU: {{ item.product.sku }}</div>
                  <div class="cart-item-stock {{ item.product.stock|stock_class }}">
                    {{ item.product.stock|stock_status|safe }}
                  </div>
                </div>
              </div>

              <div class="cart-item-price">
                <span class="price-current">{{ item.price|currency }}</span>
                {% if item.product.compareAtPrice and item.product.compareAtPrice > item.price %}
                  <span class="price-original">{{ item.product.compareAtPrice|currency }}</span>
                {% endif %}
              </div>

              <div class="cart-item-quantity">
                <div class="quantity-input">
                  <button type="button" class="quantity-btn" data-action="minus">-</button>
                  <input
                    type="number"
                    value="{{ item.quantity }}"
                    min="1"
                    max="{{ item.product.stock }}"
                    data-item-id="{{ item.id }}"
                  >
                  <button type="button" class="quantity-btn" data-action="plus">+</button>
                </div>
              </div>

              <div class="cart-item-total">
                {{ (item.price * item.quantity)|currency }}
              </div>

              <div class="cart-item-actions">
                <button type="button" class="action-btn" data-add-to-wishlist data-product-id="{{ item.product.id }}" title="Move to Wishlist">
                  <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                  </svg>
                </button>
                <button type="button" class="action-btn action-btn-danger" data-remove-from-cart data-item-id="{{ item.id }}" title="Remove">
                  <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                  </svg>
                </button>
              </div>
            </article>
          {% endfor %}

          <div class="cart-footer">
            <a href="/products" class="btn btn-outline">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
              </svg>
              Continue Shopping
            </a>
            <button type="button" class="btn btn-secondary" id="clear-cart-btn">Clear Cart</button>
          </div>
        </div>

        <!-- Cart Summary -->
        <aside class="cart-summary">
          <div class="summary-card">
            <h2 class="summary-title">Order Summary</h2>

            <div class="summary-rows">
              <div class="summary-row">
                <span>Subtotal ({{ cart.items|cart_count }} items)</span>
                <span id="cart-subtotal">{{ cart.subtotal|currency }}</span>
              </div>

              {% if cart.discount > 0 %}
                <div class="summary-row discount">
                  <span>Discount</span>
                  <span id="cart-discount">-{{ cart.discount|currency }}</span>
                </div>
              {% endif %}

              <div class="summary-row">
                <span>Shipping</span>
                <span id="cart-shipping">
                  {% if cart.subtotal >= free_shipping_threshold %}
                    <span class="free-shipping">Free</span>
                  {% else %}
                    Calculated at checkout
                  {% endif %}
                </span>
              </div>

              {% if cart.subtotal < free_shipping_threshold %}
                <div class="free-shipping-progress">
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ (cart.subtotal / free_shipping_threshold * 100)|min(100) }}%"></div>
                  </div>
                  <span class="progress-text">
                    Add {{ (free_shipping_threshold - cart.subtotal)|currency }} more for free shipping!
                  </span>
                </div>
              {% endif %}
            </div>

            <div class="summary-total">
              <span>Total</span>
              <span id="cart-total">{{ cart.total|currency }}</span>
            </div>

            <!-- Coupon -->
            <div class="coupon-section">
              <h3>Have a coupon?</h3>
              <form id="coupon-form" class="coupon-form">
                <input type="text" name="code" placeholder="Enter coupon code" value="{{ cart.coupon.code|default('') }}">
                <button type="submit" class="btn btn-secondary">Apply</button>
              </form>
              {% if cart.coupon %}
                <div class="applied-coupon">
                  <span class="coupon-badge">
                    {{ cart.coupon.code }}
                    <button type="button" data-remove-coupon>&times;</button>
                  </span>
                  <span class="coupon-discount">-{{ cart.discount|currency }}</span>
                </div>
              {% endif %}
            </div>

            <a href="/checkout" class="btn btn-primary btn-lg btn-block">
              Proceed to Checkout
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="5" y1="12" x2="19" y2="12"></line>
                <polyline points="12 5 19 12 12 19"></polyline>
              </svg>
            </a>

            <div class="payment-methods">
              <p>Secure payment with:</p>
              <div class="payment-icons">
                <img src="/images/payments/visa.svg" alt="Visa">
                <img src="/images/payments/mastercard.svg" alt="Mastercard">
                <img src="/images/payments/amex.svg" alt="Amex">
                <img src="/images/payments/paypal.svg" alt="PayPal">
              </div>
            </div>
          </div>

          <!-- Trust Badges -->
          <div class="trust-badges">
            <div class="trust-badge">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
              </svg>
              <span>Secure Checkout</span>
            </div>
            <div class="trust-badge">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
              </svg>
              <span>Easy Returns</span>
            </div>
            <div class="trust-badge">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="1" y="3" width="15" height="13"></rect>
                <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                <circle cx="5.5" cy="18.5" r="2.5"></circle>
                <circle cx="18.5" cy="18.5" r="2.5"></circle>
              </svg>
              <span>Fast Shipping</span>
            </div>
          </div>
        </aside>
      </div>

      <!-- Recently Viewed / You May Also Like -->
      {% if suggested_products|length > 0 %}
        <section class="cart-suggestions">
          <h2 class="section-title">You May Also Like</h2>
          <div class="product-grid">
            {% for product in suggested_products %}
              {% include "components/product-card.html" with product=product %}
            {% endfor %}
          </div>
        </section>
      {% endif %}

    {% else %}
      <!-- Empty Cart -->
      <div class="empty-cart">
        <div class="empty-cart-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
          </svg>
        </div>
        <h2>Your cart is empty</h2>
        <p>Looks like you haven't added any items to your cart yet.</p>
        <a href="/products" class="btn btn-primary btn-lg">Start Shopping</a>
      </div>
    {% endif %}
  </div>
</section>
{% endblock %}

{% block scripts %}
<style>
.cart-page {
  padding: 2rem 0;
}

.page-title {
  font-size: 2rem;
  font-weight: 700;
  margin-bottom: 2rem;
}

.cart-layout {
  display: grid;
  grid-template-columns: 1fr 380px;
  gap: 2rem;
  align-items: start;
}

/* Cart Items */
.cart-items {
  background: var(--white);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
  overflow: hidden;
}

.cart-header {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr 1fr 80px;
  gap: 1rem;
  padding: 1rem 1.5rem;
  background: var(--gray-50);
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--gray-600);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.cart-item {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr 1fr 80px;
  gap: 1rem;
  padding: 1.5rem;
  align-items: center;
  border-bottom: 1px solid var(--gray-200);
}

.cart-item:last-child {
  border-bottom: none;
}

.cart-item-product {
  display: flex;
  gap: 1rem;
}

.cart-item-image {
  width: 100px;
  height: 100px;
  flex-shrink: 0;
  background: var(--gray-100);
  border-radius: var(--radius);
  overflow: hidden;
}

.cart-item-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.cart-item-name {
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 0.25rem;
}

.cart-item-name a {
  color: var(--gray-900);
}

.cart-item-name a:hover {
  color: var(--primary);
}

.cart-item-options {
  font-size: 0.875rem;
  color: var(--gray-500);
  margin-bottom: 0.25rem;
}

.cart-item-options span:not(:last-child)::after {
  content: ' / ';
}

.cart-item-sku {
  font-size: 0.75rem;
  color: var(--gray-400);
  margin-bottom: 0.25rem;
}

.cart-item-stock {
  font-size: 0.75rem;
}

.cart-item-price {
  text-align: center;
}

.cart-item-price .price-current {
  display: block;
  font-weight: 600;
}

.cart-item-price .price-original {
  display: block;
  font-size: 0.875rem;
  color: var(--gray-400);
  text-decoration: line-through;
}

.cart-item-quantity {
  display: flex;
  justify-content: center;
}

.cart-item-total {
  font-size: 1.125rem;
  font-weight: 700;
  text-align: center;
}

.cart-item-actions {
  display: flex;
  justify-content: center;
  gap: 0.5rem;
}

.cart-item-actions .action-btn {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  border: 1px solid var(--gray-300);
  border-radius: var(--radius);
  color: var(--gray-500);
  background: var(--white);
  cursor: pointer;
  transition: all 0.2s;
}

.cart-item-actions .action-btn:hover {
  border-color: var(--primary);
  color: var(--primary);
}

.cart-item-actions .action-btn-danger:hover {
  border-color: var(--danger);
  color: var(--danger);
}

.cart-footer {
  display: flex;
  justify-content: space-between;
  padding: 1rem 1.5rem;
  background: var(--gray-50);
}

/* Summary */
.cart-summary {
  position: sticky;
  top: 100px;
}

.summary-card {
  background: var(--white);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
  padding: 1.5rem;
}

.summary-title {
  font-size: 1.25rem;
  font-weight: 600;
  margin-bottom: 1.5rem;
}

.summary-rows {
  margin-bottom: 1.5rem;
}

.summary-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.75rem;
  font-size: 0.875rem;
}

.summary-row.discount {
  color: var(--success);
}

.free-shipping {
  color: var(--success);
  font-weight: 500;
}

.free-shipping-progress {
  margin-top: 1rem;
  padding: 0.75rem;
  background: var(--gray-50);
  border-radius: var(--radius);
}

.progress-bar {
  height: 8px;
  background: var(--gray-200);
  border-radius: var(--radius-full);
  overflow: hidden;
  margin-bottom: 0.5rem;
}

.progress-fill {
  height: 100%;
  background: var(--primary);
  border-radius: var(--radius-full);
  transition: width 0.3s;
}

.progress-text {
  font-size: 0.75rem;
  color: var(--gray-600);
}

.summary-total {
  display: flex;
  justify-content: space-between;
  padding: 1rem 0;
  border-top: 2px solid var(--gray-200);
  border-bottom: 2px solid var(--gray-200);
  font-size: 1.25rem;
  font-weight: 700;
  margin-bottom: 1.5rem;
}

.coupon-section {
  margin-bottom: 1.5rem;
}

.coupon-section h3 {
  font-size: 0.875rem;
  font-weight: 500;
  margin-bottom: 0.75rem;
}

.coupon-form {
  display: flex;
  gap: 0.5rem;
}

.coupon-form input {
  flex: 1;
  padding: 0.5rem 0.75rem;
  border: 1px solid var(--gray-300);
  border-radius: var(--radius);
}

.applied-coupon {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 0.75rem;
}

.coupon-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.25rem 0.75rem;
  background: var(--success);
  color: var(--white);
  font-size: 0.75rem;
  font-weight: 600;
  border-radius: var(--radius);
}

.coupon-badge button {
  background: none;
  border: none;
  color: var(--white);
  cursor: pointer;
  font-size: 1rem;
}

.coupon-discount {
  font-weight: 600;
  color: var(--success);
}

.payment-methods {
  margin-top: 1.5rem;
  text-align: center;
}

.payment-methods p {
  font-size: 0.75rem;
  color: var(--gray-500);
  margin-bottom: 0.5rem;
}

.payment-icons {
  display: flex;
  justify-content: center;
  gap: 0.5rem;
}

.payment-icons img {
  height: 24px;
  opacity: 0.7;
}

.trust-badges {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
  margin-top: 1.5rem;
}

.trust-badge {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  padding: 1rem;
  background: var(--gray-50);
  border-radius: var(--radius);
  text-align: center;
}

.trust-badge .icon {
  color: var(--primary);
}

.trust-badge span {
  font-size: 0.75rem;
  font-weight: 500;
  color: var(--gray-600);
}

/* Empty Cart */
.empty-cart {
  text-align: center;
  padding: 4rem 2rem;
  background: var(--white);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
}

.empty-cart-icon {
  width: 120px;
  height: 120px;
  margin: 0 auto 2rem;
  color: var(--gray-300);
}

.empty-cart-icon svg {
  width: 100%;
  height: 100%;
}

.empty-cart h2 {
  font-size: 1.5rem;
  margin-bottom: 0.5rem;
}

.empty-cart p {
  color: var(--gray-500);
  margin-bottom: 2rem;
}

/* Suggestions */
.cart-suggestions {
  margin-top: 4rem;
}

@media (max-width: 1024px) {
  .cart-layout {
    grid-template-columns: 1fr;
  }

  .cart-summary {
    position: static;
  }
}

@media (max-width: 768px) {
  .cart-header {
    display: none;
  }

  .cart-item {
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  .cart-item-product {
    flex-direction: column;
    align-items: flex-start;
  }

  .cart-item-image {
    width: 100%;
    height: auto;
    aspect-ratio: 1;
  }

  .cart-item-price, .cart-item-quantity, .cart-item-total {
    text-align: left;
  }

  .cart-item-actions {
    justify-content: flex-start;
  }

  .trust-badges {
    grid-template-columns: 1fr;
  }
}
</style>

<script>
// Clear cart
document.getElementById('clear-cart-btn')?.addEventListener('click', async () => {
  if (confirm('Are you sure you want to clear your cart?')) {
    try {
      const res = await fetch('/api/cart/clear', { method: 'DELETE' })
      const data = await res.json()
      if (data.success) {
        location.reload()
      }
    } catch (err) {
      TechStore.showNotification('Failed to clear cart', 'error')
    }
  }
})

// Remove coupon
document.querySelector('[data-remove-coupon]')?.addEventListener('click', async () => {
  try {
    const res = await fetch('/api/cart/coupon', { method: 'DELETE' })
    const data = await res.json()
    if (data.success) {
      location.reload()
    }
  } catch (err) {
    TechStore.showNotification('Failed to remove coupon', 'error')
  }
})
</script>
{% endblock %}
